language: go

go:
  - "1.11.x"
  - "1.12.x"
  - "master"

matrix:
  allow_failures:
    - go: "master"

  fast_finish: true

before_script:
  - GO_FILES=$(find . -iname '*.go' -type f | grep -v /vendor/) # All the .go files, excluding vendor/
  - go get honnef.co/go/tools/cmd/staticcheck                   # Badass static analyzer/linter
  - go get github.com/fzipp/gocyclo
  - go get github.com/mitchellh/gox
  - go get github.com/golang/dep/cmd/dep

script:
  - dep init                                 # fetch any dependencies
  - test -z $(gofmt -s -l $GO_FILES)         # Fail if a .go file hasn't been formatted with gofmt
  - go test -v -race ./...                   # Run all the tests with the race detector enabled
  - go vet ./...                             # go vet is the official Go static analyzer
  - staticcheck ./...                          # "go vet on steroids" + linter
  - gocyclo -over 19 $GO_FILES               # forbid code with huge functions
  - make release                             # build release binaries

deploy:
  provider: releases
  api_key:
    secure: OmfuvB/p/8LR2mflEZUpTkLY7CE0wYadH9lxzOiseqimltjiThqX6MvO1Y5fVayIy3DECCG7Vfw2xTvVQFNWJ9xLMOBouokDyXMhaQJa9ybott7Vcd9nUZ7vltQk3N8cCYhXp6TVu7b3Hpis09n0gNZoXo5Raysk63jEIGa5+QnNQW7zfqJN/FR1kRq88Oo1VHr6AjyarwWOggKhe7fwsUHdiHk8Otdp2E2EjygNmXxVDI6uhESafRs0cbL6xlOCKyp7oxnZCshQ4OzDo++W95I5eoC1uAv0LxbYdh8LkyUslElptSUssU+xEBzLxXwcI+Y2rdNn/pIbOPpeifJv16ezFXa42Xjy0lecywPIIAVjsOpxp/jvFEsl0gJWnIEm15cdMHfZhtzJJ6aPW9C+AORHVZIHEpZNhsdcB0uSRhWvDRvOL8s3OsRMYndu48e0o5HuZJngIYyuSgGKKhOJGHh/r3wrvdbBPYYvElaD/wlgmVPM4py/wQf1SK98V884CG9cLIc9fYWMBdOveRItFtHQpEdV4gUE4VYkuziTo1AHUb8pGRg/8oGqb9sSKrgYT/JI5DMaeiz+3LpmLVzZEasIShYs0d9I2aDcbS6IvBdVsCptngmNZYCZQ+iVh+4p6Odocy30i3RIO1ipPXsIFTRRyGab97gDCRGF+LPasKA=
  file_glob: true
  file: 'bin/defang_*' 
  skip_cleanup: true
  on:
    repo: jakewarren/defang
    tags: true
